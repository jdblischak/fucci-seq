---
title: "Phase-specific scores for Leng et al. 2015"
author: "Joyce Hsiao"
output: html_document
---

<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
```{r read-chunk, include=FALSE, cache=FALSE}
knitr::read_chunk("chunks.R")
```

<!-- Update knitr chunk options -->
```{r knitr-opts-chunk, include=FALSE}
```

<!-- Insert the date the file was last updated -->
```{r last-updated, echo=FALSE, results='asis'}
```

<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
```{r code-version, echo=FALSE, results='asis'}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning=FALSE)
```

---

## Overview/Results

1. Consider the fucci-expression human ESC in [Leng et al. 2015](doi:10.1038/nmeth.3549)

2. What are the expression profiles of the sorted cells given the phase-specific scores in [Macoscko et al. 2015](http://dx.doi.org/10.1016/j.cell.2015.05.002)?

* G1 cells score high on M/G1, G1/S, and M.  
* S cells score high on G1/S, and S.  
* G2 cells score high oh G2 and M.

Compared to the preliminary analysis of our data ([here](https://jdblischak.github.io/fucci-seq/images-goldstandards.html)), we observe this pattern in some individuals but not all of the individuals. What's clear is that phase-specific scores along are not adequate in predicting cell cycle phase. Importantly, there appears to be a pattern in average expression levels within each cell state (fucci-assigned). G1 cells peaks at M/G1 and G1/S, S cells peaks at S, while G2 cells peaks at G2. 

3. 123 genes were identified as variable along cell cycle phase. 

---

## Data and packages

Packages

```{r}
library(Biobase)
library(ggplot2)
library(cowplot)
library(data.table)
library(tidyr)
```

Load the normalized and filtered data from Leng et al 2015. 

```{r}
#install_github("jhsiao999/singleCellRNASeqHumanLengESC")
library("singleCellRNASeqHumanLengESC")
data("HumanLengESC")

counts <- exprs(HumanLengESC)
libsize <- colSums(counts)
cpm <- t(t(counts)*(10^6)/libsize)
log2cpm <- log2(cpm+1)
pdata <- pData(HumanLengESC)

table(pData(HumanLengESC)$cell_state)
```

select fucci-expression cells

```{r}
cpm <- cpm[,pdata$cell_state != "H1"]
log2cpm <- log2cpm[,pdata$cell_state != "H1"]
pdata <- pdata[pdata$cell_state != "H1", ]
```

filter genes

```{r}
genes_to_include <- which(rowMeans(cpm)>1)
log2cpm <- log2cpm[genes_to_include,]
```

import cell cycle genes info

```{r}
cellcycle <- readRDS("../data/cellcycle-genes-previous-studies/rds/macosko-2017.rds")
which_cc <- which(rownames(log2cpm) %in% cellcycle$hgnc)
```

subset genes to include only cell cycle genes

```{r}
log2cpm_cc <- log2cpm[which_cc, ]
cc_genes <- cellcycle[which(cellcycle$hgnc %in% rownames(log2cpm)),]
```

compute phase-specific scores

```{r}
cc_scores <- lapply(1:uniqueN(cc_genes$phase), function(i) {
  ph <- unique(cc_genes$phase)[i]
  df_sub <- log2cpm_cc[rownames(log2cpm_cc) %in% cc_genes$hgnc[cc_genes$phase == ph],]
  mn <- colMeans(df_sub)
  cc <- cor(t(rbind(mn, df_sub)))
  cc_mean <- cc[-1,1]
  genes_cc <- names(cc_mean)[which(cc_mean > .3)]
  scores_raw <- colMeans(df_sub[rownames(df_sub) %in% genes_cc,])
  scores_z <- scale(scores_raw)
  return(list(scores_z=scores_z, ngenes = length(genes_cc)))
})
names(cc_scores) <- unique(cc_genes$phase)


ngenes <- sapply(cc_scores, function(x) x[[2]])
print(ngenes)

scores <- do.call(cbind, lapply(cc_scores, function(x) x[[1]]))
colnames(scores) <- unique(cc_genes$phase)

scores_z <- t(apply(scores, 1, scale))
colnames(scores_z) <- unique(cc_genes$phase)
scores_z <- as.data.frame(scores_z)

scores_z_long <- gather(scores_z, key=phase, value=scores)
scores_z_long$sample_id <- rep(rownames(scores_z), ncol(scores_z))

scores_z_long$cell_state <- pdata$cell_state[match(scores_z_long$sample_id, rownames(pdata))]
```


---


## Analysis

```{r, fig.width=8, fig.height=5, echo = F}
scores_z_long$phase <- factor(scores_z_long$phase, 
                                 levels=c("M/G1", "G1/S", "S", "G2", "M"))
scores_z_long$cell_state <- factor(scores_z_long$cell_state, 
                                 levels=c("G1", "S", "G2"))

ggplot(data=scores_z_long, 
       aes(x=phase, y=scores, 
           col=phase)) +
  geom_violin() +
  geom_boxplot(width=.1) +
  facet_wrap(~cell_state) +
  ylab("phase-specific score") +
  ggtitle("Sorted human ESCs in Leng et al. 2015",
          subtitle="G1 91 cells, S 80 cells, G2 76 cells")
```

---

## Session information

```{r, echo = FALSE}
sessionInfo()
```



